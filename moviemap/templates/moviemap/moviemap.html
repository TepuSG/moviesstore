{% extends 'base.html' %}
{% block content %}
{% load static %}

<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

<style>
  #map {
    width: 100%;
    height: 600px;
  }
  .popup-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  .popup-list li {
    font-size: 14px;
  }
</style>

<div class="container mt-4">
  <h2 class="mb-4">Trending Movies Map</h2>
  <hr />
  <div id="map"></div>
</div>

<script>
  mapboxgl.accessToken = '{{ template_data.mapbox_key }}';
  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v11',
    center: [-98.5795, 39.8283], // Centered on USA
    zoom: 3
  });

  map.addControl(new mapboxgl.NavigationControl());

  // Fetch trending movie data from backend
  fetch('/cart/api/trending/')
    .then(res => res.json())
    .then(data => {
      for (const [location, movies] of Object.entries(data)) {
        // Convert location name (e.g. "New York") to coordinates
        fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(location)}.json?access_token={{ template_data.mapbox_key }}`)
          .then(r => r.json())
          .then(geo => {
            if (geo.features.length > 0) {
              const coords = geo.features[0].geometry.coordinates;
              const movieList = movies
                .map(m => `<li>${m.title} (${m.count})</li>`)
                .join('');
              const popupHTML = `
                <strong>${location}</strong>
                <ul class="popup-list">${movieList}</ul>
              `;
              new mapboxgl.Marker({ color: '#d63384' })
                .setLngLat(coords)
                .setPopup(new mapboxgl.Popup().setHTML(popupHTML))
                .addTo(map);
            }
          });
      }
    })
    .catch(err => console.error('Error loading map data:', err));
</script>

{% endblock content %}
